{% extends "layout_bbs.html" %}
{% block content %}
    <nav class="nav" style="overflow-y: scroll;">
        <div class="inner">
        <ul>
            <li><a href="/profile/{{current_user.id}}"><i class="fa-solid fa-user"></i>{{current_user.name}}</a></li>
            <li><a class="add_member_btn"><i class="fa-solid fa-user-group"></i>メンバの追加</a></li>
            <li><a href="/setting/{{current_user.id}}"><i class="fa-solid fa-gear"></i>設定</a></li>
            {% if current_user.is_admin %}
                <li><a href="/confirm"><i class="fa-solid fa-book"></i>ユーザ確認</a></li>
                <li><a href="/admin"><i class="fa-solid fa-hammer"></i>管理者</a></li>
                <li><a href="/load_data"><i class="fa-solid fa-download"></i>データのロード</a></li>
            {% endif %}
            <li><a href="/logout"><i class="fa-solid fa-right-from-bracket"></i>ログアウト</a></li>
        </ul>
        </div>
        <nav class="sp-nav2">
            <div class="inner">
                <p style="margin: 0px;">スレッド</p>
                <ul>
                    {% for ua in user_access %}
                        {% set active_thread="" %}
                        {% if ua.thread_id==thread_id%}
                            {% set active_thread="active" %}
                        {% endif %}
                        <li><a href="/bbs/{{ua.thread_id}}" class="select_thread {{active_thread}}"><i class="fa-solid fa-sitemap"></i>{{ua.threads.thread_name}}</a></li>
                    {% endfor %}
                    <li class="new"><a class="new_thread"><i class="fa-solid fa-plus"></i>スレッドを作成</a></li>
                    <li class="delete"><a class="delete_thread"><i class="fa-solid fa-trash"></i>スレッドを削除</a></li>
                </ul>
            </div>
        </nav>
    </nav>
    <nav class="nav2">
        <div class="inner">
        <ul>
            {% for ua in user_access %}
                {% set active_thread="" %}
                {% if ua.thread_id==thread_id%}
                    {% set active_thread="active" %}
                {% endif %}
                <li><a href="/bbs/{{ua.thread_id}}" class="select_thread {{active_thread}}"><i class="fa-solid fa-sitemap"></i>{{ua.threads.thread_name}}</a></li>
            {% endfor %}
            <li class="new"><a class="new_thread"><i class="fa-solid fa-plus"></i>スレッドを作成</a></li>
            <li class="delete"><a class="delete_thread"><i class="fa-solid fa-trash"></i>スレッドを削除</a></li>
        </ul>
        </div>
    </nav>
    <div class="mask"></div>
    <div class="title-band"></div>
    <div class="openbtn1" style="margin-top:3vh;"><span></span><span></span><span></span></div>
    <h1 class="h1-title">{{ title }}</h1>
        <div class="row justify-content-center">
            <div class="col-11 custom-col">
                <div class="scrollable-container" id="scrollable_box">
                    <div id="scroller__inner">
                        {%for m in messages %}
                            {% set jc="justify-content-start" %}
                            {% set msbox="othre-message-box" %}
                            {% if m.__dict__['user_id']==current_user.id %}
                                {% set jc="justify-content-end" %}
                                {% set msbox="my-message-box" %}
                            {% endif %}
                                <div class="row {{jc}} layer1">
                                <div class="col-9 {{jc}} fix-btn">
                                    <p class="{{msbox}} inf-message"><span class="p-msg-name">{{m.users.name}}</span> :
                                    {{m.__dict__['sendtime']}}{% if m.user_id==current_user.id%}<span><a href="#">編集</a>&ensp;<a href="#">削除</a>{% endif %}</span></p>
                                    <div class="small-screen-content close"><!-- スマホ用の画面 -->
                                        {% if messages_count[loop.index0] <=27 %}<p class="{{msbox}}" style="overflow-wrap: break-word; word-wrap: break-word;"><span class="message-box back-color">{{m.__dict__['message']}}</span></p>
                                        {% else %}<p class="{{msbox}} multi-rows " style="overflow-wrap: break-word; word-wrap: break-word;">{{m.__dict__['message']}}</p>
                                        {% endif %}
                                    </div>
                                    <div class="large-screen-content open"><!-- PC用の画面 -->
                                        {% if messages_count[loop.index0] <=56 %}<p class="{{msbox}}" style="overflow-wrap: break-word; word-wrap: break-word;"><span class="message-box back-color">{{m.__dict__['message']}}</span></p>
                                        {% else %}<p class="{{msbox}} multi-rows " style="overflow-wrap: break-word; word-wrap: break-word;">{{m.__dict__['message']}}</p>
                                        {% endif %}
                                    </div>

                                </div> 
                            </div>
                        {% endfor %}
                    </div>
                </div>
    
                <form action="/bbs/{{thread_id}}" method="post", class="message-form">
                    {{ form.hidden_tag() }}
                    <div class="row">
                        <div class="col-11 submit-text">
                            {{ form.message(placeholder="メッセージを入力", class="form-control",id='text_area')}}
                        </div>
                        <div class="col-1">
                            <div class="float-right">
                                <button class="btn btn-primary one-clk-btn" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    <form action="{{ url_for('add_member', previous_thread = thread_id) }}" method="post" class="add_member">
        {{ new_thread_form.hidden_tag() }}
        <h3>"{{title}}"にメンバを追加する</h3>
        <p>メンバー</p>
        <ul>
            {% for member_form in new_thread_form.member %}
                <li>{{ member_form}} {{ member_form.label }}</li>
            {% endfor %}
        </ul>
        <div style="text-align: right;margin-top:10px;">
            <a class="btn btn-primary btn-sm add_cancel">キャンセル</a>
            <button class="btn btn-primary btn-sm" type="submit">メンバを追加</button>
        </div>
    </form>
    <form action="{{ url_for('new_thread', previous_thread = thread_id) }}" method="post" class="make_thread">
        {{ new_thread_form.hidden_tag() }}
        <h3>新しいスレッドを作成する</h3>
        {{ new_thread_form.thread_name.label(class="col-form-label")}}
        {{ new_thread_form.thread_name(placeholder="スレッド名", class="form-control",rows=1)}}
        <br>
        <p>メンバー</p>
        <ul>
            {% for member_form in new_thread_form.member %}
                <li>{{ member_form}} {{ member_form.label }}</li>
            {% endfor %}
        </ul>
        <div style="text-align: right;margin-top:10px;">
            <a class="btn btn-primary btn-sm cancel">キャンセル</a>
            <button class="btn btn-primary btn-sm one-clk-btn create-thread" type="submit">スレッドを作成する</button>
        </div>
    </form>
    <form action="{{ url_for('delete_thread', delete_thread = thread_id) }}" method="post" class="delete_display">
        {{ delete_form.hidden_tag() }}
        <h3>"{{title}}"を削除しますか?</h3>
        {{ delete_form.radio_field()}}
        <div style="text-align: right;margin-top:10px;">
            <a class="btn btn-primary btn-sm delete_cancel">キャンセル</a>
            <button class="btn btn-primary btn-sm one-clk-btn delete-thread" type="submit">スレッドを削除</button>
    </form>
    <script>
        const scrollerInner = document.getElementById("scroller__inner");
        scrollerInner.scrollIntoView(false);
        var thread_id = "{{ thread_id }}";
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <script src="../static/js/bbs.js"></script>
{% endblock %}